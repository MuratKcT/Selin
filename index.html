<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selin's Study Site</title>
    <!-- Neon/Uzay Yazı Tipi -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ======================================= */
        /* CSS (Stil) - UZAY TEMASI (Galaksi Yükseltmesi) */
        /* ======================================= */
        
        body {
            font-family: 'Orbitron', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #0a0a1a; /* Fallback */
            color: #ecf0f1; 
            
            background-image: url('https://images.pexels.com/photos/1252890/pexels-photo-1252890.jpeg');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
            overflow-x: hidden; 
        }
        
        /* Başlık Alanı (Header) */
        header {
            background: rgba(0, 0, 0, 0.3);
            color: #00ffff;
            padding: 2rem 0;
            text-align: center;
            border-bottom: 2px solid #00ffff;
            /* GÜNCELLEME: Neon kısıldı */
            text-shadow: 0 0 4px #00ffff, 0 0 8px #00ffff;
        }
        header h1 {
            margin: 0;
            font-size: 2.5rem;
        }

        /* Ana İçerik Alanı (Quizleri Ortala) */
        main {
            flex-grow: 1;
            padding: 30px 20px;
            max-width: 1200px;
            width: 100%; 
            margin: 0 auto; 
            display: flex; 
            gap: 30px; 
            flex-wrap: wrap; 
            justify-content: center;
            align-items: flex-start; /* Kutuları üste hizala */
        }

        /* Quiz Konteyner Stil (Tüm 3 Kutu için) */
        #quiz-container, #irregular-verb-quiz-container, #ai-quiz-generator-container {
            flex: 1 1 30%; /* Üç kutu için esnek genişlik */
            min-width: 350px; 
            max-width: 550px;
            padding: 30px;
            background: rgba(28, 40, 51, 0.85); 
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); /* GÜNCELLEME: Neon kısıldı */
            border: 1px solid #00ffff;
            border-top: 5px solid #00ffff; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeIn 1s ease-out; 
            margin: 10px;
        }
        
        /* AI Quiz Kutusuna özel stil */
        #ai-quiz-generator-container {
             border-top: 5px solid #f1c40f; /* AI Kutusu için sarı */
             box-shadow: 0 0 20px rgba(241, 196, 15, 0.2); /* GÜNCELLEME: Neon kısıldı */
             border: 1px solid #f1c40f;
        }

        /* Hover Animasyonu */
        #quiz-container:hover, #irregular-verb-quiz-container:hover, #ai-quiz-generator-container:hover {
            transform: translateY(-5px); 
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5); /* GÜNCELLEME: Neon kısıldı */
        }
        #ai-quiz-generator-container:hover {
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.5); /* GÜNCELLEME: Neon kısıldı */
        }

        /* Başlıklar ve Metinler */
        h2 {
            color: #00ffff; 
            text-shadow: 0 0 2px #00ffff, 0 0 4px #00ffff;  /* GÜNCELLEME: Neon kısıldı */
            width: 100%; 
            box-sizing: border-box; 
            border-bottom: 2px solid rgba(0, 255, 255, 0.2); 
            padding-bottom: 15px;
            margin-top: 0;
        }
        #ai-quiz-generator-container h2 {
             color: #f1c40f; /* AI Başlığı */
             text-shadow: 0 0 2px #f1c40f, 0 0 4px #f1c40f;  /* GÜNCELLEME: Neon kısıldı */
             border-bottom-color: rgba(241, 196, 15, 0.2);
        }
        
        p, span, li, label { 
            color: #ecf0f1; 
            text-shadow: 0 0 1px rgba(236, 240, 241, 0.5); /* GÜNCELLEME: Neon kısıldı */
        }
        #question, #verb-base-form {
            color: #f1c40f; 
            font-size: 1.7rem !important;
            text-shadow: 0 0 3px #f1c40f, 0 0 7px #f1c40f; /* GÜNCELLEME: Neon kısıldı */
        }
        
        /* Matematik Soru Stili */
        .q-divider {
            color: #00ffff;
            margin: 0 10px;
            text-shadow: 0 0 3px #00ffff; /* GÜNCELLEME: Neon kısıldı */
            font-weight: bold;
        }

        /* Giriş Kutuları */
        input[type="number"], input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 15px;
            border: 1px solid #00ffff;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: #ecf0f1; 
            color: #333;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            font-family: 'Orbitron', 'Segoe UI', sans-serif; 
        }

        /* Giriş Kutusu Odaklanma Animasyonu */
        input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus {
            background-color: #fff;
            border-color: #f1c40f; 
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.7); 
            transform: scale(1.02); 
            outline: none; 
        }

        /* Butonlar */
        button {
            background-color: #00ffff; 
            color: #0a0a1a; 
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s, box-shadow 0.3s ease;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.4); /* GÜNCELLEME: Neon kısıldı */
            font-family: 'Orbitron', 'Segoe UI', sans-serif; 
        }
        button:hover {
            background-color: #ffffff; 
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6); /* GÜNCELLEME: Neon kısıldı */
            transform: scale(1.02);
        }
        button:disabled {
            background-color: #7f8c8d;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        /* Hata düzeltme/AI butonları için stil */
        #gemini-example-button, #next-verb-button, #math-hint-button {
            display: none; /* Hepsi başlangıçta gizli */
            color: #0a0a1a; 
            margin-top: 10px;
        }
        #gemini-example-button, #math-hint-button {
            background-color: #f1c40f; /* Sarı AI butonu */
        }
        #next-verb-button {
            background-color: #1abc9c; /* Yeşil Sonraki butonu */
            margin-left: 10px; /* Aralarında boşluk */
        }


        /* Geri Bildirim ve Puan Alanı */
        #score, #verb-score {
            font-weight: bold;
            color: #e74c3c; 
        }

        /* Animasyon Tanımı */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Ebeveyn Paneli Modalı (Uzay Teması) */
        .modal {
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2c3e50;
            padding: 25px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4); /* GÜNCELLEME: Neon kısıldı */
            border: 1px solid #e74c3c;
            border-top: 5px solid #e74c3c;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus {
            color: #e74c3c;
            text-decoration: none;
        }
        #reports-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        #reports-list li {
            background: #3a5369;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            color: #bdc3c7;
        }

        /* Gemini Modal Stili */
        .modal-content.gemini-modal-content {
            border-top-color: #f1c40f; 
            border-color: #f1c40f;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.4); /* GÜNCELLEME: Neon kısıldı */
        }
        .modal-content.gemini-modal-content h2 {
            color: #f1c40f;
        }
        #gemini-modal-content {
            background-color: #3a5369;
            padding: 15px;
            border-radius: 8px;
            color: #ecf0f1;
            white-space: pre-wrap; 
            font-family: 'Orbitron', 'Courier New', Courier, monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* AI Quiz Oluşturucu Stilleri */
        #ai-quiz-display-area {
            margin-top: 20px;
        }
        .ai-question {
            margin-bottom: 15px;
        }
        .ai-question p {
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 10px;
        }
        .ai-option {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .ai-option input {
            margin-right: 10px;
        }
        #ai-quiz-result {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 20px;
        }
        /* AI Quiz Açıklama Stili */
        .ai-explanation {
            display: none;
            color: #f1c40f;
            margin-top: 10px;
            font-size: 0.9rem;
            border-left: 3px solid #f1c40f;
            padding-left: 10px;
            font-style: italic;
            /* GÜNCELLEME: Çift dil için beyaz boşluk korunmalı */
            white-space: pre-wrap; 
        }


        /* Yükleme Spinner'ı */
        .spinner {
            border: 4px solid rgba(0, 255, 255, 0.3); 
            border-top: 4px solid #00ffff; 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 20px 0;
            color: #bdc3c7;
            font-size: 0.9rem;
            border-top: 1px solid #00ffff;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Mobil Uyumluluk (Responsive) */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            
            main {
                flex-direction: column; /* Kutuları alt alta yığ */
                align-items: center; /* Kutuları ortala */
                padding: 10px;
            }
            
            #quiz-container, #irregular-verb-quiz-container, #ai-quiz-generator-container {
                flex-basis: 100%; /* Tam genişlik kapla */
                min-width: 90%; /* Ekranın %90'ı */
                margin: 10px 0;
            }
            
            #question, #verb-base-form {
                font-size: 1.4rem !important;
            }
            
            button, #parent-access-button {
                font-size: 1rem;
                padding: 10px 15px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            
            #parent-access-button {
                bottom: 10px;
                right: 10px;
            }
        }
        
    </style>
</head>
<body>
    <header>
        <!-- GÜNCELLEME: Başlık değişti -->
        <h1>Welcome to board Captain Selin!</h1>
    </header>

    <main>
        <!-- IRREGULAR VERBS QUIZ (English) -->
        <div id="irregular-verb-quiz-container">
            <h2>English Exercise: Irregular Verbs</h2>
            
            <div id="verb-question-area">
                <p id="verb-base-form" style="font-size: 1.5rem; font-weight: bold;">Loading verb...</p>
                
                <p>Simple Past (V2):</p>
                <input type="text" id="verb-v2-input" placeholder="V2 form">
                
                <p>Past Participle (V3):</p>
                <input type="text" id="verb-v3-input" placeholder="V3 form">
                
                <button id="verb-submit-button">Check Verb</button>
                
                <button id="gemini-example-button">✨ Show Example Sentence</button>
                <button id="next-verb-button">Next Verb &rarr;</button>
                
                <p id="verb-feedback" style="margin-top: 15px; font-weight: bold;"></p>
                
            </div>
            
            <div id="verb-score-container" style="margin-top: 20px;">
                <p>Score: <span id="verb-score">0</span> / <span id="verb-total-questions">0</span></p>
            </div>
        </div>

        <!-- MULTIPLICATION QUIZ (Math) - YENİLENDİ -->
        <div id="quiz-container">
            <h2>Math Exercise: Operations</h2>
            
            <p id="question" style="font-size: 1.5rem; font-weight: bold;">Loading question...</p>
            
            <input type="number" id="answer-input" placeholder="Enter your answer">
            
            <button id="submit-button">Check</button>
            
            <button id="math-hint-button">✨ Підказка? (Hint?)</button>
            
            <p id="feedback" style="margin-top: 15px; font-weight: bold;"></p>
            
            <div id="score-container" style="margin-top: 20px;">
                <p>Score: <span id="score">0</span> / <span id="total-questions">10</span></p>
            </div>
        </div>
        
        <!-- YENİ: AI QUIZ GENERATOR - Adı Değişti -->
        <div id="ai-quiz-generator-container">
            <h2>✨ Galactic Quiz Zone</h2>
            
            <div id="ai-quiz-setup">
                <p>Введіть тему, яку хочете вивчити (напр. Planets, Animals, Colors):</p>
                <input type="text" id="ai-topic-input" placeholder="Введіть тему...">
                <button id="ai-generate-button">Generate Quiz</button>
            </div>
            
            <div id="ai-quiz-display-area" style="display: none;">
                <!-- Quiz soruları buraya dinamik olarak eklenecek -->
            </div>
            
            <div id="ai-quiz-result" style="display: none;">
                <!-- Quiz sonucu buraya gelecek -->
            </div>
        </div>
        
        <!-- Parent Access Button -->
        <button id="parent-access-button" style="position: fixed; bottom: 20px; right: 20px; z-index: 5; background-color: #e74c3c; color: white; box-shadow: 0 0 10px rgba(231, 76, 60, 0.7);">Galactic Points</button>
    </main>

    <footer>
        <p>&copy; 2025 Selin's Educational Platform</p>
    </footer>

    <!-- Ebeveyn Kontrol Paneli Modalı (Yeniden Düzenlendi) -->
    <div id="parent-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 style="color: #e74c3c;">Galactic Points</h2>
            
            <p id="pin-feedback" style="color: #f1c40f; font-weight: bold; min-height: 20px;"></p>

            <!-- GÜNCELLEME: PIN ekranı düzeltildi (çift yazı kaldırıldı) -->
            <div id="auth-area">
                <input type="password" id="parent-pin-input" placeholder="PIN Code">
                <button id="pin-submit-button" style="background-color: #e74c3c;">Access</button>
            </div>

            <div id="reports-area" style="display: none;">
                <h3 style="color: #1abc9c;">Selin's Progress Reports</h3>
                <!-- GÜNCELLEME: Buton metni değişti -->
                <button id="gemini-summary-button" style="background-color: #f1c40f; color: #0a0a1a; margin-bottom: 15px;">✨ Admiral's Report</button>
                <ul id="reports-list">
                    <li>Loading results...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Gemini AI Modal -->
    <div id="gemini-modal" class="modal">
        <div class="modal-content gemini-modal-content">
            <span class="close-button gemini-close-button">&times;</span>
            <h2 id="gemini-modal-title" style="color: #f1c40f;">✨ AI Assistant</h2>
            
            <div id="gemini-loading-spinner" style="display: none; text-align: center; margin-top: 20px;">
                <div class="spinner"></div>
                <p style="color: #00ffff;">Generating...</p>
            </div>
            
            <div id="gemini-modal-content" style="display: none;">
                <p>Loading...</p>
            </div>
        </div>
    </div>


    <script>
        // =======================================
        // 1. Parallax Arka Plan (Fare + Jiroskop)
        // =======================================
        
        // A. Fare (Mouse) ile Parallax
        window.addEventListener('mousemove', function(e) {
            // Sadece fare varsa çalışsın (mobil olmayan)
            if (e.pointerType === "mouse") {
                const mouseX = e.clientX;
                const mouseY = e.clientY;
                
                // Hareketi yavaşlat
                const bgPosX = -(mouseX / 100);
                const bgPosY = -(mouseY / 100);
                
                document.body.style.backgroundPosition = `${bgPosX}px ${bgPosY}px`;
            }
        });

        // B. Mobil Cihaz Hareket Sensörü (Gyroscope) ile Parallax
        let hasRequestedOrientation = false;

        function handleOrientation(event) {
            // beta: (tilt front-to-back)
            // gamma: (tilt left-to-right)
            const beta = event.beta;  
            const gamma = event.gamma; 
            
            if (beta === null || gamma === null) return;

            // Hassasiyeti ayarla (düşük sayı = daha yavaş hareket)
            const sensitivity = 8;
            
            // Cihazın normal duruşuna göre ayarla
            const bgPosX = -(gamma / sensitivity);
            const bgPosY = -(beta / sensitivity);

            document.body.style.backgroundPosition = `${bgPosX}px ${bgPosY}px`;
        }

        // iOS 13+ için izin isteme
        function requestOrientationPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                    })
                    .catch(console.error);
            } else {
                // Android veya izne gerek olmayan cihazlar
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }
        
        // Jiroskobu sadece mobil cihazlarda etkinleştir (ilk dokunuşta)
        // 'touchstart' olayı, kullanıcının mobil cihazda olduğunu gösterir
        window.addEventListener('touchstart', function() {
            if (!hasRequestedOrientation) {
                requestOrientationPermission();
                hasRequestedOrientation = true;
            }
        }, { once: true });


        // =======================================
        // 2. LocalStorage (Tarayıcı Hafızası) Ebeveyn Kontrolü
        // =======================================

        async function saveQuizResult(quizType, score, total, isCorrect, detail) {
            try {
                let reports = JSON.parse(localStorage.getItem('selinQuizReports')) || [];
                const resultData = {
                    quizType: quizType,
                    score: score,
                    totalQuestions: total,
                    isCorrect: isCorrect,
                    detail: detail,
                    timestamp: new Date().toISOString()
                };
                reports.unshift(resultData);
                if (reports.length > 100) {
                    reports = reports.slice(0, 100);
                }
                localStorage.setItem('selinQuizReports', JSON.stringify(reports));
                console.log(`Result saved to LocalStorage for ${quizType}.`);
            } catch (e) {
                console.error("Error saving to LocalStorage:", e);
            }
        }

        // =======================================
        // Parent Dashboard Logic (LocalStorage Versiyonu)
        // =======================================

        const parentModal = document.getElementById('parent-modal');
        const parentAccessButton = document.getElementById('parent-access-button');
        const closeButton = parentModal.querySelector('.close-button');
        const pinSubmitButton = document.getElementById('pin-submit-button');
        const parentPinInput = document.getElementById('parent-pin-input');
        const pinFeedback = document.getElementById('pin-feedback');
        const authArea = document.getElementById('auth-area');
        const reportsArea = document.getElementById('reports-area');
        const reportsList = document.getElementById('reports-list');
        const geminiSummaryButton = document.getElementById('gemini-summary-button'); 
        
        // GÜNCELLEME: PIN değişti
        const CORRECT_PIN = "3355";

        parentAccessButton.onclick = () => {
            reportsArea.style.display = 'none';
            authArea.style.display = 'block';
            parentPinInput.value = '';
            // GÜNCELLEME: PIN istemi düzeltildi ve İngilizce'ye çevrildi
            pinFeedback.textContent = "Enter PIN (Hint: 3355):";
            pinFeedback.style.color = '#f1c40f';
            parentModal.style.display = 'flex';
        };

        closeButton.onclick = () => {
            parentModal.style.display = 'none';
        };

        window.onclick = (event) => {
            if (event.target === parentModal) {
                parentModal.style.display = 'none';
            }
        };

        pinSubmitButton.onclick = () => {
            const enteredPin = parentPinInput.value.trim();
            if (enteredPin === CORRECT_PIN) {
                pinFeedback.textContent = 'Доступ надано! Отримання звітів...';
                pinFeedback.style.color = '#1abc9c';
                authArea.style.display = 'none';
                reportsArea.style.display = 'block';
                geminiSummaryButton.style.display = 'block'; 
                fetchReportsFromLocalStorage();
            } else {
                pinFeedback.textContent = 'Неправильний PIN. Спробуйте ще раз.';
                pinFeedback.style.color = '#e74c3c';
            }
        };
        
        // GÜNCELLEME: PIN girişi için Enter tuşu eklendi
        parentPinInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                pinSubmitButton.click();
            }
        });


        function fetchReportsFromLocalStorage() {
            reportsList.innerHTML = '<li>Завантаження результатів...</li>';
            try {
                const reports = JSON.parse(localStorage.getItem('selinQuizReports')) || [];
                reportsList.innerHTML = '';
                if (reports.length === 0) {
                    reportsList.innerHTML = '<li>Ще немає збережених результатів вікторини.</li>';
                    return;
                }
                
                reports.forEach(data => {
                    const li = document.createElement('li');
                    const time = new Date(data.timestamp).toLocaleString('uk-UA', {
                        day: '2-digit', month: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit'
                    });
                    
                    li.innerHTML = `
                        <strong>${data.quizType}</strong> - ${time}<br>
                        Результат: ${data.isCorrect ? '<span style="color: #1abc9c;">Правильно</span>' : '<span style="color: #e74c3c;">Неправильно</span>'} (Питання ${data.totalQuestions})<br>
                        Деталі: ${data.detail}
                    `;
                    reportsList.appendChild(li);
                });
            } catch (error) {
                console.error("Error fetching reports from LocalStorage: ", error);
                reportsList.innerHTML = `<li>Помилка отримання звітів: ${error.message}</li>`;
            }
        }
        
        // =======================================
        // 4. Gemini API Fonksiyonları (API Anahtarlı)
        // =======================================

        const geminiModal = document.getElementById('gemini-modal');
        const geminiModalTitle = document.getElementById('gemini-modal-title');
        const geminiModalContent = document.getElementById('gemini-modal-content');
        const geminiLoadingSpinner = document.getElementById('gemini-loading-spinner');
        const geminiCloseButton = geminiModal.querySelector('.gemini-close-button');

        function showGeminiModal(title) {
            geminiModalTitle.textContent = title;
            geminiModalContent.style.display = 'none';
            geminiLoadingSpinner.style.display = 'block';
            geminiModal.style.display = 'flex';
        }

        function updateGeminiModal(content) {
            geminiLoadingSpinner.style.display = 'none';
            geminiModalContent.style.display = 'block';
            // GÜNCELLEME: Çift dil için HTML'i işle
            geminiModalContent.innerHTML = content;
        }

        function hideGeminiModal() {
            geminiModal.style.display = 'none';
        }
        
        geminiCloseButton.onclick = hideGeminiModal;
        
        // Gemini API'yi çağıran ana fonksiyon
        async function callGeminiAPI(userPrompt, systemInstructionText = null, useGrounding = false, jsonSchema = null) {
            // GÜNCELLEME: Yükleme metni İngilizce ve Tematik olarak değişti
            showGeminiModal("✨ Engaging Lightspeed Communication...");
            
            const YOUR_API_KEY = "AIzaSyCi4V_K9kfGM2BU-DzF2uWG1mYlYyX17I4"; 
            const apiKey = (typeof __GEMINI_API_KEY__ !== 'undefined' && __GEMINI_API_KEY__ !== "") ? __GEMINI_API_KEY__ : YOUR_API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            if (!apiKey) {
                updateGeminiModal("Помилка: API-ключ не налаштовано. AI-функції вимкнено.");
                return;
            }

            let payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
            };

            if (systemInstructionText) {
                payload.systemInstruction = { parts: [{ text: systemInstructionText }] };
            }
            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }
            if (jsonSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                };
            }

            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 403) {
                             throw new Error("API key is not valid or permissions are missing. (403 Forbidden)");
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        const text = result.candidates[0].content.parts[0].text;
                        if (jsonSchema) {
                            hideGeminiModal(); 
                            return text; 
                        }
                        // GÜNCELLEME: Metni HTML olarak işle
                        updateGeminiModal(text.replace(/\n/g, '<br>')); 
                        return text;
                    } else {
                        if (result.candidates && result.candidates[0].finishReason === "SAFETY") {
                             throw new Error("Content was blocked due to safety reasons.");
                        }
                        throw new Error("Invalid API response structure or no content generated.");
                    }

                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    retries--;
                    if (retries === 0) {
                        const errorMsg = `Помилка виклику AI: ${error.message}.`;
                        updateGeminiModal(errorMsg);
                        return errorMsg;
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; 
                }
            }
        }
        
        // Gemini Özet Butonu
        geminiSummaryButton.onclick = async () => {
            try {
                const reports = JSON.parse(localStorage.getItem('selinQuizReports')) || [];
                if (reports.length === 0) {
                    showGeminiModal("✨ AI Summary");
                    updateGeminiModal("Ще немає звітів для узагальнення. Селін повинна спочатку пройти декілька вікторин!");
                    return;
                }

                const reportsText = reports.map(r => 
                    `Quiz: ${r.quizType}, Correct: ${r.isCorrect}, Detail: ${r.detail}`
                ).slice(0, 20).join('\n'); 

                const systemPrompt = "You are a friendly and encouraging educational assistant. Analyze the following quiz results from a student named Selin. Provide a very short, 2-3 bullet point summary of her progress. Identify one area she is strong in and one area she could practice more. **Respond in Ukrainian.**";
                const userPrompt = `Here are Selin's latest quiz results (most recent first):\n${reportsText}`;

                await callGeminiAPI(userPrompt, systemPrompt);

            } catch (error) {
                console.error("Error generating summary:", error);
                updateGeminiModal(`Error generating summary: ${error.message}`);
            }
        };

        // =======================================
        // 5. Quiz Mantığı
        // =======================================

        // 1. Math Operations Quiz Logic
        const questionEl = document.getElementById('question');
        const answerInput = document.getElementById('answer-input');
        const submitButton = document.getElementById('submit-button');
        const feedbackEl = document.getElementById('feedback');
        const scoreEl = document.getElementById('score');
        const totalQuestionsEl = document.getElementById('total-questions');
        const quizContainer = document.getElementById('quiz-container');
        const mathHintButton = document.getElementById('math-hint-button'); 

        let currentScore = 0;
        let currentQuestionNumber = 0;
        const totalQuestions = 10;
        let correctAnswer = 0;
        let currentMathQuestion = '';

        function generateRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Dört İşlemli Soru Üretici
        function generateNewQuestion() {
            if (currentQuestionNumber >= totalQuestions) {
                quizContainer.innerHTML = `
                    <h3>Quiz Finished!</h3>
                    <p>Your total score is: ${currentScore} / ${totalQuestions}.</p>
                    <p style="color: #1abc9c; font-weight: bold;">Congratulations, you worked hard!</p>
                `;
                return;
            }

            currentQuestionNumber++;
            mathHintButton.style.display = 'none'; 
            
            const opType = Math.floor(Math.random() * 4); // 0:+, 1:-, 2:*, 3:/
            let num1, num2, operationSymbol;

            switch(opType) {
                case 0: // Toplama (Sonuç < 100)
                    num1 = generateRandomNumber(1, 70);
                    num2 = generateRandomNumber(1, 29);
                    correctAnswer = num1 + num2;
                    operationSymbol = '+';
                    break;
                case 1: // Çıkarma (Sonuç negatif olmasın)
                    num1 = generateRandomNumber(10, 99);
                    num2 = generateRandomNumber(1, num1); 
                    correctAnswer = num1 - num2;
                    operationSymbol = '-';
                    break;
                case 2: // Çarpma (Sonuç < 100)
                    num1 = generateRandomNumber(2, 12);
                    num2 = generateRandomNumber(2, 9);
                    if (num1 * num2 > 100) { 
                         num1 = generateRandomNumber(2, 9);
                    }
                    correctAnswer = num1 * num2;
                    operationSymbol = 'x';
                    break;
                case 3: // Bölme (Kalansız)
                    num2 = generateRandomNumber(2, 10); 
                    let result = generateRandomNumber(2, 10);
                    num1 = num2 * result; 
                    correctAnswer = result;
                    operationSymbol = '÷';
                    break;
            }
            
            currentMathQuestion = `${num1} ${operationSymbol} ${num2}`;
            questionEl.innerHTML = `Question ${currentQuestionNumber} <span class="q-divider">>></span> ${currentMathQuestion} = ?`;
            answerInput.value = '';
            feedbackEl.textContent = '';
            submitButton.disabled = false;
            answerInput.focus();
        }

        // Matematik İpucu Butonu Olayı
        mathHintButton.onclick = async () => {
            const systemPrompt = "You are a helpful math teacher. The student is 10 years old. Provide a very simple, one-sentence hint in **Ukrainian** for the following math problem. Do not give the answer.";
            const userPrompt = `Provide a hint for: ${currentMathQuestion}`;
            await callGeminiAPI(userPrompt, systemPrompt);
        };

        async function checkAnswer() {
            if (submitButton.disabled) return; 
            
            const userAnswer = parseInt(answerInput.value);
            if (isNaN(userAnswer)) {
                feedbackEl.textContent = "Please enter a number.";
                feedbackEl.style.color = '#f1c40f';
                return;
            }
            
            let isCorrect = (userAnswer === correctAnswer);

            if (isCorrect) {
                currentScore++;
                scoreEl.textContent = currentScore;
                feedbackEl.textContent = 'CORRECT! You are great.';
                feedbackEl.style.color = '#1abc9c';
                submitButton.disabled = true;
                mathHintButton.style.display = 'none'; 
                setTimeout(generateNewQuestion, 1000);
            } else {
                feedbackEl.textContent = 'WRONG! Try again.';
                feedbackEl.style.color = '#e74c3c';
                mathHintButton.style.display = 'inline-block'; 
            }

            await saveQuizResult(
                "Math Operations", 
                currentScore, 
                currentQuestionNumber, 
                isCorrect, 
                `${currentMathQuestion} = ${userAnswer} (Correct: ${correctAnswer})`
            );
        }

        submitButton.addEventListener('click', checkAnswer);
        // GÜNCELLEME: 'keypress' -> 'keydown'
        answerInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        generateNewQuestion();

        // 2. Irregular Verbs Quiz Logic
        const irregularVerbs = [
            { v1: "be", v2: "was/were", v3: "been" }, { v1: "go", v2: "went", v3: "gone" }, { v1: "do", v2: "did", v3: "done" }, { v1: "see", v2: "saw", v3: "seen" }, { v1: "come", v2: "came", v3: "come" }, { v1: "eat", v2: "ate", v3: "eaten" }, { v1: "write", v2: "wrote", v3: "written" }, { v1: "run", v2: "ran", v3: "run" }, { v1: "take", v2: "took", v3: "taken" }, { v1: "make", v2: "made", v3: "made" }, { v1: "say", v2: "said", v3: "said" }, { v1: "get", v2: "got", v3: "got/gotten" }, { v1: "give", v2: "gave", v3: "given" }, { v1: "find", v2: "found", v3: "found" }, { v1: "know", v2: "knew", v3: "known" }, { v1: "think", v2: "thought", v3: "thought" }, { v1: "tell", v2: "told", v3: "told" }, { v1: "become", v2: "became", v3: "become" }, { v1: "leave", v2: "left", v3: "left" }, { v1: "hear", v2: "heard", v3: "heard" },
        ];

        const verbBaseFormEl = document.getElementById('verb-base-form');
        const verbV2Input = document.getElementById('verb-v2-input');
        const verbV3Input = document.getElementById('verb-v3-input');
        const verbSubmitButton = document.getElementById('verb-submit-button');
        const verbFeedbackEl = document.getElementById('verb-feedback');
        const verbScoreEl = document.getElementById('verb-score');
        const verbTotalQuestionsEl = document.getElementById('verb-total-questions');
        const irregularVerbQuizContainer = document.getElementById('irregular-verb-quiz-container');
        const geminiExampleButton = document.getElementById('gemini-example-button'); 
        const nextVerbButton = document.getElementById('next-verb-button');

        let currentVerbScore = 0;
        let currentVerbIndex = -1;
        const totalVerbQuestions = irregularVerbs.length;
        verbTotalQuestionsEl.textContent = totalVerbQuestions;
        let currentVerbData = null; 

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        let shuffledVerbs = shuffleArray(irregularVerbs); 

        function generateNewVerbQuestion() {
            currentVerbIndex++;

            if (currentVerbIndex >= totalVerbQuestions) {
                irregularVerbQuizContainer.innerHTML = `
                    <h3>Quiz Finished!</h3>
                    <p>Your Irregular Verbs score: ${currentVerbScore} / ${totalVerbQuestions}.</p>
                    <p style="color: #1abc9c; font-weight: bold;">Great job, Selin!</p>
                `;
                return;
            }

            currentVerbData = shuffledVerbs[currentVerbIndex]; 
            verbBaseFormEl.textContent = `Verb Base Form (V1): ${currentVerbData.v1}`;
            
            verbV2Input.value = '';
            verbV3Input.value = '';
            verbFeedbackEl.textContent = '';
            verbSubmitButton.disabled = false;
            
            geminiExampleButton.style.display = 'none'; 
            nextVerbButton.style.display = 'none';
            
            verbV2Input.focus();
        }

        async function checkVerbAnswer() {
            if (verbSubmitButton.disabled) return;

            const currentVerb = currentVerbData; 
            const userAnswerV2 = verbV2Input.value.trim().toLowerCase();
            const userAnswerV3 = verbV3Input.value.trim().toLowerCase();
            
            const correctV2s = currentVerb.v2.split('/').map(c => c.trim().toLowerCase());
            const correctV3s = currentVerb.v3.split('/').map(c => c.trim().toLowerCase());
            
            const isV2Correct = correctV2s.includes(userAnswerV2);
            const isV3Correct = correctV3s.includes(userAnswerV3);
            
            let feedbackMessage = '';
            let isCorrect = false;
            let currentVerbNumber = currentVerbIndex + 1;

            if (isV2Correct && isV3Correct) {
                currentVerbScore++;
                verbScoreEl.textContent = currentVerbScore;
                feedbackMessage = 'PERFECT! Both forms are correct.';
                feedbackEl.style.color = '#1abc9c';
                isCorrect = true;
                setTimeout(generateNewVerbQuestion, 2000);
            } else {
                feedbackMessage = 'WRONG! The correct forms are: ';
                feedbackMessage += `V2: ${currentVerb.v2}, V3: ${currentVerb.v3}.`;
                feedbackEl.style.color = '#e74c3c';
                isCorrect = false;
                geminiExampleButton.style.display = 'inline-block'; 
                nextVerbButton.style.display = 'inline-block'; 
            }

            verbFeedbackEl.textContent = feedbackMessage;
            verbSubmitButton.disabled = true;

            await saveQuizResult(
                "Irregular Verbs", 
                currentVerbScore, 
                currentVerbNumber, 
                isCorrect, 
                `V1: ${currentVerb.v1}, Your V2/V3: ${userAnswerV2}/${userAnswerV3}`
            );
        }

        verbSubmitButton.addEventListener('click', checkVerbAnswer);
        nextVerbButton.addEventListener('click', generateNewVerbQuestion);
        
        geminiExampleButton.onclick = async () => {
            if (!currentVerbData) return;

            const verb = currentVerbData;
            // GÜNCELLEME: Çift dil talebi
            const systemPrompt = "You are an English teacher. The user is an 8-year-old student named Selin. Write one, very simple example sentence for *each* of the 3 verb forms (V1, V2, V3). First show the sentence in **English**, then provide the **Ukrainian translation** on a new line. Format it clearly, using markdown for bolding the verbs.";
            const simplePrompt = `Write 3 very simple example sentences for an 8-year-old using the verb "${verb.v1}".
1. One sentence using the base form (${verb.v1}).
2. One sentence using the simple past form (${verb.v2}).
3. One sentence using the past participle form (${verb.v3}).`;

            await callGeminiAPI(simplePrompt, systemPrompt);
        };

        // GÜNCELLEME: 'keypress' -> 'keydown'
        verbV3Input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                checkVerbAnswer();
            }
        });

        generateNewVerbQuestion();
        
        // =======================================
        // 6. YENİ: AI Quiz Generator Logic
        // =======================================
        
        const aiTopicInput = document.getElementById('ai-topic-input');
        const aiGenerateButton = document.getElementById('ai-generate-button');
        const aiQuizDisplayArea = document.getElementById('ai-quiz-display-area');
        const aiQuizSetup = document.getElementById('ai-quiz-setup');
        const aiQuizResult = document.getElementById('ai-quiz-result');
        
        let aiQuizCorrectAnswers = []; 
        let aiQuizExplanations = []; 

        // GÜNCELLEME: Çift dilli açıklama için JSON Şeması
        const quizSchema = {
            type: "OBJECT",
            properties: {
                questions: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            question: { type: "STRING" },
                            options: { type: "ARRAY", items: { type: "STRING" } },
                            correctAnswerIndex: { type: "NUMBER" },
                            explanation_en: { type: "STRING" }, // İngilizce Açıklama
                            explanation_uk: { type: "STRING" }  // Ukraynaca Açıklama
                        },
                        required: ["question", "options", "correctAnswerIndex", "explanation_en", "explanation_uk"]
                    }
                }
            },
            required: ["questions"]
        };

        // Quiz oluşturma butonu
        aiGenerateButton.onclick = async () => {
            const topic = aiTopicInput.value.trim();
            if (topic === "") {
                alert("Please enter a topic."); 
                return;
            }
            
            aiQuizSetup.style.display = 'none';
            aiQuizResult.style.display = 'none';
            aiQuizDisplayArea.style.display = 'block';
            aiQuizDisplayArea.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Generating your quiz...</p>';

            // GÜNCELLEME: Sistem talimatı (8 yaş, ESL, çift dilli açıklama)
            const systemPrompt = "You are a quiz generator for an 8-year-old student (Selin) who is learning English as a second language (ESL) and whose native language is Ukrainian. Create a 5-question multiple-choice quiz (4 options each) about the user's topic. The questions must be **very simple** (A1/A2 level, basic vocabulary). **All quiz text (questions and options) must be in simple English.** For *each* question, provide two brief, simple explanations for the correct answer: one in **simple English** (for `explanation_en`) and one in **Ukrainian** (for `explanation_uk`).";
            const userPrompt = `Topic: ${topic}`;

            try {
                // Gemini'yi JSON moduyla çağır
                const jsonString = await callGeminiAPI(userPrompt, systemPrompt, false, quizSchema);
                const quizData = JSON.parse(jsonString);
                
                if (quizData && quizData.questions) {
                    renderAiQuiz(quizData.questions);
                } else {
                    throw new Error("Failed to generate quiz data in the correct format.");
                }
            } catch (error) {
                console.error("Failed to generate or parse AI quiz:", error);
                aiQuizDisplayArea.innerHTML = `<p style="color: #e74c3c;">Error generating quiz: ${error.message}</p>`;
                aiQuizSetup.style.display = 'block'; // Kuruluma geri dön
            }
        };
        
        // GÜNCELLEME: AI konu girişi için Enter tuşu eklendi
        aiTopicInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                aiGenerateButton.click();
            }
        });
        
        // Gemini'den gelen quizi HTML'e dönüştürür
        function renderAiQuiz(questions) {
            aiQuizCorrectAnswers = questions.map(q => q.correctAnswerIndex);
            // GÜNCELLEME: Çift dilli açıklamaları sakla
            aiQuizExplanations = questions.map(q => ({
                en: q.explanation_en,
                uk: q.explanation_uk
            }));
            
            let quizHtml = '';
            
            questions.forEach((q, qIndex) => {
                quizHtml += `<div class="ai-question" id="ai-q-${qIndex}">`;
                quizHtml += `<p>${qIndex + 1}. ${q.question}</p>`;
                q.options.forEach((option, oIndex) => {
                    quizHtml += `
                        <label class="ai-option">
                            <input type="radio" name="ai-q-${qIndex}" value="${oIndex}">
                            ${option}
                        </label>
                    `;
                });
                quizHtml += `<div class="ai-explanation" id="ai-exp-${qIndex}"></div>`;
                quizHtml += `</div>`;
            });
            
            quizHtml += `<button id="ai-check-button" style="background-color: #f1c40f; color: #0a0a1a; margin-top: 20px;">Check AI Quiz</button>`;
            aiQuizDisplayArea.innerHTML = quizHtml;
            
            document.getElementById('ai-check-button').onclick = checkAiQuiz;
        }

        // Dinamik quiz'in cevaplarını kontrol eder
        function checkAiQuiz() {
            let score = 0;
            aiQuizCorrectAnswers.forEach((correctIndex, qIndex) => {
                const radios = document.getElementsByName(`ai-q-${qIndex}`);
                let userAnswer = -1;
                for (let i = 0; i < radios.length; i++) {
                    if (radios[i].checked) {
                        userAnswer = parseInt(radios[i].value);
                        break;
                    }
                }
                
                const questionDiv = document.getElementById(`ai-q-${qIndex}`);
                const labels = questionDiv.getElementsByTagName('label');
                
                // GÜNCELLEME: Çift dilli açıklamayı al ve göster
                const explanation = aiQuizExplanations[qIndex];
                const expDiv = document.getElementById(`ai-exp-${qIndex}`);
                const explanationHtml = `
                    <strong>(EN):</strong> ${explanation.en}<br>
                    <strong>(UK):</strong> ${explanation.uk}
                `;
                
                if (userAnswer === correctIndex) {
                    score++;
                    labels[userAnswer].style.color = '#1abc9c'; // Doğruyu yeşil yap
                    expDiv.innerHTML = explanationHtml;
                    expDiv.style.color = '#1abc9c';
                    expDiv.style.display = 'block';
                } else {
                    if (userAnswer !== -1) {
                         labels[userAnswer].style.color = '#e74c3c'; // Yanlışı kırmızı yap
                    }
                    labels[correctIndex].style.color = '#1abc9c'; // Doğruyu yine de yeşil göster
                    
                    expDiv.innerHTML = explanationHtml; 
                    expDiv.style.color = '#f1c40f'; // Açıklama sarı olsun
                    expDiv.style.display = 'block';
                }
            });
            
            aiQuizResult.innerHTML = `Your Score: <span style="color: #f1c40f;">${score} / ${aiQuizCorrectAnswers.length}</span>`;
            aiQuizResult.style.display = 'block';
            document.getElementById('ai-check-button').style.display = 'none'; // Butonu gizle
            
            // Tekrar deneme butonu
             aiQuizDisplayArea.innerHTML += `<button id="ai-reset-button" style="background-color: #00ffff; color: #0a0a1a; margin-top: 20px;">Try Another Topic</button>`;
             document.getElementById('ai-reset-button').onclick = () => {
                 aiQuizDisplayArea.style.display = 'none';
                 aiQuizResult.style.display = 'none';
                 aiTopicInput.value = '';
                 aiQuizSetup.style.display = 'block';
             };
        }
        
    </script>
</body>
</html>
