// ... (HTML ve CSS kodları yukarıda)

    <script>
        // =======================================
        // Firebase Initialization and Core Functions
        // =======================================
        
        // Canvas Global Değişkenlerini Kontrol Etme
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db = null;
        let auth = null;
        let userId = 'student_selin'; // Varsayılan kullanıcı ID'si (Selin)
        let isAuthReady = false;

        // Firebase'i Başlatma ve Kimlik Doğrulama
        if (firebaseConfig && window.initializeApp) {
            try {
                const app = window.initializeApp(firebaseConfig);
                db = window.getFirestore(app);
                auth = window.getAuth(app);
                
                // Kullanıcı Durumu Değişikliğini Dinleme
                window.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase initialized. User ID:", userId);
                    } else {
                        // Token varsa custom token ile, yoksa anonim giriş yap
                        if (initialAuthToken) {
                            await window.signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await window.signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    // Auth hazır olduğunda, belki bekleyen raporları hemen çekebiliriz (ancak şimdilik sadece hazır bayrağını ayarlıyoruz).
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        } else {
            console.error("Firebase libraries or config not available.");
        }

        // Sonuçları Firestore'a Kaydetme Fonksiyonu
        async function saveQuizResult(quizType, score, total, isCorrect, detail) {
            if (!isAuthReady || !db) {
                console.error("Firebase not ready or DB not initialized. Cannot save data.");
                // Burada datanın kaydedilmediğini belirten geçici bir mesaj gösterilebilir, ancak şimdilik konsol hatası yeterli.
                return;
            }

            const resultData = {
                userId: userId,
                quizType: quizType,
                score: score,
                totalQuestions: total,
                isCorrect: isCorrect,
                detail: detail,
                timestamp: window.serverTimestamp()
            };

            // ÖNEMLİ: Bu yol, Canvas güvenlik kurallarına uyar.
            const path = `artifacts/${appId}/users/${userId}/quiz_results`;

            try {
                // Özel koleksiyona sonucu ekleme
                await window.addDoc(window.collection(db, path), resultData);
                console.log(`Result saved for ${quizType}.`);
            } catch (e) {
                console.error("Error saving document:", e);
                // Kullanıcıya da görsel olarak bildirim gösterebiliriz.
                alert(`Error: Could not save result for ${quizType}. Please try again.`);
            }
        }

        // =======================================
        // Parent Dashboard Logic (Güncellendi)
        // =======================================

        const parentModal = document.getElementById('parent-modal');
        const parentAccessButton = document.getElementById('parent-access-button');
        const closeButton = document.querySelector('.close-button');
        const pinSubmitButton = document.getElementById('pin-submit-button');
        const parentPinInput = document.getElementById('parent-pin-input');
        const pinFeedback = document.getElementById('pin-feedback');
        const authArea = document.getElementById('auth-area');
        const reportsArea = document.getElementById('reports-area');
        const reportsList = document.getElementById('reports-list');
        
        const CORRECT_PIN = "1234"; // Ebeveyn PIN kodu

        parentAccessButton.onclick = () => {
            parentModal.style.display = 'flex';
        };

        closeButton.onclick = () => {
            parentModal.style.display = 'none';
            // Paneli sıfırla
            authArea.style.display = 'block';
            reportsArea.style.display = 'none';
            pinFeedback.textContent = '';
            parentPinInput.value = '';
        };

        window.onclick = (event) => {
            if (event.target === parentModal) {
                parentModal.style.display = 'none';
            }
        };

        pinSubmitButton.onclick = () => {
            const enteredPin = parentPinInput.value.trim();
            if (enteredPin === CORRECT_PIN) {
                
                // PIN doğru, şimdi Firebase hazır mı kontrol et.
                if (!isAuthReady || !db) {
                     pinFeedback.textContent = 'PIN correct, but still waiting for secure connection. Try again in 5 seconds.';
                     pinFeedback.style.color = '#f1c40f'; // Sarı uyarı
                     return;
                }

                pinFeedback.textContent = 'Access granted!';
                pinFeedback.style.color = '#1abc9c';
                authArea.style.display = 'none';
                reportsArea.style.display = 'block';
                fetchReports();
            } else {
                pinFeedback.textContent = 'Incorrect PIN. Try again.';
                pinFeedback.style.color = '#e74c3c';
            }
        };

        // Raporları Firebase'den Çekme
        function fetchReports() {
            if (!isAuthReady || !db) {
                // Bu durumun zaten PIN kontrolünde yakalanması beklenir, ama ekstra güvenlik.
                reportsList.innerHTML = '<li>Error: Authentication is not complete. Please try again in a moment.</li>';
                return;
            }
            
            reportsList.innerHTML = '<li>Fetching latest results...</li>';

            const path = `artifacts/${appId}/users/${userId}/quiz_results`;
            const resultsQuery = window.query(window.collection(db, path));
            
            // onSnapshot ile gerçek zamanlı dinleme
            window.onSnapshot(resultsQuery, (snapshot) => {
                reportsList.innerHTML = ''; // Listeyi temizle
                if (snapshot.empty) {
                    reportsList.innerHTML = '<li>No quiz results recorded yet.</li>';
                    return;
                }
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    
                    const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                    
                    li.innerHTML = `
                        <strong>${data.quizType}</strong> - ${time}<br>
                        Score: ${data.isCorrect ? 'Correct' : 'Wrong'} (Attempt ${data.totalQuestions})<br>
                        Detail: ${data.detail}
                    `;
                    reportsList.appendChild(li);
                });
            }, (error) => {
                console.error("Error fetching reports: ", error);
                reportsList.innerHTML = `<li>Error fetching reports: ${error.message}</li>`;
            });
        }


        // =======================================
        // 3. Quiz Mantığına Veri Kaydını Entegre Etme
        // (Burada bir değişiklik yapılmadı, sadece önceki kodun devamı)
        // =======================================

        // 1. Math Multiplication Quiz Logic (English)
        const questionEl = document.getElementById('question');
        const answerInput = document.getElementById('answer-input');
        const submitButton = document.getElementById('submit-button');
        const feedbackEl = document.getElementById('feedback');
        const scoreEl = document.getElementById('score');
        const totalQuestionsEl = document.getElementById('total-questions');
        const quizContainer = document.getElementById('quiz-container');

        let currentScore = 0;
        let currentQuestionNumber = 0;
        const totalQuestions = 10;
        let correctAnswer = 0;
        let currentMathQuestion = ''; // Kayıt için soru metnini tutar

        function generateRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateNewQuestion() {
            if (currentQuestionNumber >= totalQuestions) {
                quizContainer.innerHTML = `
                    <h3>Quiz Finished!</h3>
                    <p>Your total score is: ${currentScore} / ${totalQuestions}.</p>
                    <p style="color: #1abc9c; font-weight: bold;">Congratulations, you worked hard!</p>
                `;
                return;
            }

            currentQuestionNumber++;
            const num1 = generateRandomNumber(1, 10);
            const num2 = generateRandomNumber(1, 10);
            correctAnswer = num1 * num2;
            
            currentMathQuestion = `${num1} x ${num2}`;
            questionEl.textContent = "Question " + currentQuestionNumber + ": " + currentMathQuestion + " = ?";
            answerInput.value = '';
            feedbackEl.textContent = '';
            submitButton.disabled = false;
            answerInput.focus();
        }

        async function checkAnswer() {
            if (submitButton.disabled) return; 
            
            const userAnswer = parseInt(answerInput.value);
            if (isNaN(userAnswer)) {
                feedbackEl.textContent = "Please enter a number.";
                feedbackEl.style.color = '#f1c40f'; // Yellowish warning
                return;
            }
            
            let isCorrect = (userAnswer === correctAnswer);

            if (isCorrect) {
                currentScore++;
                scoreEl.textContent = currentScore;
                feedbackEl.textContent = 'CORRECT! You are great.';
                feedbackEl.style.color = '#1abc9c'; // Green
                submitButton.disabled = true;
                setTimeout(generateNewQuestion, 1000);
            } else {
                feedbackEl.textContent = 'WRONG! Try again.';
                feedbackEl.style.color = '#e74c3c'; // Red
            }

            // SONUCU KAYDETME
            await saveQuizResult(
                "Math", 
                currentScore, 
                currentQuestionNumber, 
                isCorrect, 
                `${currentMathQuestion} = ${userAnswer} (Correct: ${correctAnswer})`
            );
        }

        submitButton.addEventListener('click', checkAnswer);
        answerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        generateNewQuestion();

        // 2. Irregular Verbs Quiz Logic (English)
        const irregularVerbs = [
            { v1: "be", v2: "was/were", v3: "been" },
            { v1: "go", v2: "went", v3: "gone" },
            { v1: "do", v2: "did", v3: "done" },
            { v1: "see", v2: "saw", v3: "seen" },
            { v1: "come", v2: "came", v3: "come" },
            { v1: "eat", v2: "ate", v3: "eaten" },
            { v1: "write", v2: "wrote", v3: "written" },
            { v1: "run", v2: "ran", v3: "run" },
            { v1: "take", v2: "took", v3: "taken" },
            { v1: "make", v2: "made", v3: "made" },
            { v1: "say", v2: "said", v3: "said" },
            { v1: "get", v2: "got", v3: "got/gotten" },
            { v1: "give", v2: "gave", v3: "given" },
            { v1: "find", v2: "found", v3: "found" },
            { v1: "know", v2: "knew", v3: "known" },
            { v1: "think", v2: "thought", v3: "thought" },
            { v1: "tell", v2: "told", v3: "told" },
            { v1: "become", v2: "became", v3: "become" },
            { v1: "leave", v2: "left", v3: "left" },
            { v1: "hear", v2: "heard", v3: "heard" },
        ];

        const verbBaseFormEl = document.getElementById('verb-base-form');
        const verbV2Input = document.getElementById('verb-v2-input');
        const verbV3Input = document.getElementById('verb-v3-input');
        const verbSubmitButton = document.getElementById('verb-submit-button');
        const verbFeedbackEl = document.getElementById('verb-feedback');
        const verbScoreEl = document.getElementById('verb-score');
        const verbTotalQuestionsEl = document.getElementById('verb-total-questions');
        const irregularVerbQuizContainer = document.getElementById('irregular-verb-quiz-container');


        let currentVerbScore = 0;
        let currentVerbIndex = -1;
        const totalVerbQuestions = irregularVerbs.length;
        verbTotalQuestionsEl.textContent = totalVerbQuestions;
        let currentVerbData = null; // Kayıt için fiil verisini tutar

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        let shuffledVerbs = shuffleArray(irregularVerbs); 

        function generateNewVerbQuestion() {
            currentVerbIndex++;

            if (currentVerbIndex >= totalVerbQuestions) {
                irregularVerbQuizContainer.innerHTML = `
                    <h3>Quiz Finished!</h3>
                    <p>Your Irregular Verbs score: ${currentVerbScore} / ${totalVerbQuestions}.</p>
                    <p style="color: #1abc9c; font-weight: bold;">Great job, Selin!</p>
                `;
                return;
            }

            currentVerbData = shuffledVerbs[currentVerbIndex];
            verbBaseFormEl.textContent = `Verb Base Form (V1): ${currentVerbData.v1}`;
            
            verbV2Input.value = '';
            verbV3Input.value = '';
            verbFeedbackEl.textContent = '';
            verbSubmitButton.disabled = false;
            verbV2Input.focus();
        }

        async function checkVerbAnswer() {
            if (verbSubmitButton.disabled) return;

            const currentVerb = currentVerbData;
            const userAnswerV2 = verbV2Input.value.trim().toLowerCase();
            const userAnswerV3 = verbV3Input.value.trim().toLowerCase();
            
            const correctV2s = currentVerb.v2.split('/').map(c => c.trim().toLowerCase());
            const correctV3s = currentVerb.v3.split('/').map(c => c.trim().toLowerCase());
            
            const isV2Correct = correctV2s.includes(userAnswerV2);
            const isV3Correct = correctV3s.includes(userAnswerV3);
            
            let feedbackMessage = '';
            let isCorrect = false;
            let currentVerbNumber = currentVerbIndex + 1;

            if (isV2Correct && isV3Correct) {
                currentVerbScore++;
                verbScoreEl.textContent = currentVerbScore;
                feedbackMessage = 'PERFECT! Both forms are correct.';
                verbFeedbackEl.style.color = '#1abc9c'; 
                isCorrect = true;
            } else {
                feedbackMessage = 'WRONG! The correct forms are: ';
                feedbackMessage += `V2: ${currentVerb.v2}, V3: ${currentVerb.v3}.`;
                verbFeedbackEl.style.color = '#e74c3c'; 
                isCorrect = false;
            }

            verbFeedbackEl.textContent = feedbackMessage;
            verbSubmitButton.disabled = true;

            // SONUCU KAYDETME
            await saveQuizResult(
                "Irregular Verbs", 
                currentVerbScore, 
                currentVerbNumber, 
                isCorrect, 
                `V1: ${currentVerb.v1}, Your V2/V3: ${userAnswerV2}/${userAnswerV3}`
            );


            if (isCorrect) {
                setTimeout(generateNewVerbQuestion, 2000);
            } else {
                setTimeout(generateNewVerbQuestion, 3000);
            }
        }

        verbSubmitButton.addEventListener('click', checkVerbAnswer);

        verbV3Input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        generateNewVerbQuestion();
    </script>
</body>
</html>
